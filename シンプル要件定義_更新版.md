# シンプル要件定義（更新版）

## 1. 料金体系の変更

### 1.1 新しい料金体系
- **月額費用**: 2週間無料 → 3,900円
- **コンテンツ追加**: 翌月の月額費用に課金
- **無料期間中の解約**: 料金発生なし

### 1.2 料金計算例
```
例1: 1コンテンツ利用
- 初月: 無料（2週間）
- 2ヶ月目以降: 3,900円/月

例2: 2コンテンツ利用
- 初月: 無料（2週間）
- 2ヶ月目: 3,900円（基本）+ 1,500円（追加コンテンツ）= 5,400円
- 3ヶ月目以降: 5,400円/月

例3: 無料期間中に解約
- 料金発生: 0円
```

## 2. データベース設計（更新版）

### 2.1 企業テーブル
```sql
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    trial_end TIMESTAMP,  -- 無料期間終了日
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 コンテンツサブスクリプションテーブル
```sql
CREATE TABLE company_content_subscriptions (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    stripe_subscription_item_id VARCHAR(255),
    stripe_price_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 追加日
    next_billing_date TIMESTAMP,  -- 次回課金日
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type)
);
```

### 2.3 状態管理テーブル
```sql
CREATE TABLE company_status_logs (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    action_type VARCHAR(50) NOT NULL,  -- 'register', 'add_content', 'remove_content', 'cancel'
    content_type VARCHAR(100),
    details JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id)
);
```

## 3. Stripe連携（更新版）

### 3.1 料金設定
```python
# Stripe料金設定
BASE_PRICE_ID = "price_base_3900"  # 基本料金3,900円
CONTENT_ADDITION_PRICE_ID = "price_content_1500"  # 追加コンテンツ1,500円

# 無料期間設定
TRIAL_PERIOD_DAYS = 14  # 2週間無料
```

### 3.2 決済フロー
```
1. 企業登録時
   - Stripe Customer作成
   - 基本サブスクリプション作成（2週間無料）
   - trial_endを設定

2. コンテンツ追加時
   - 翌月の請求サイクルに追加コンテンツ料金を設定
   - next_billing_dateを記録

3. 無料期間中の解約
   - 料金発生なしで解約処理
   - 状態ログに記録
```

## 4. API設計（更新版）

### 4.1 企業登録API
```
POST /api/v1/company/register
Content-Type: application/json

Request:
{
    "company_name": "株式会社サンプル",
    "email": "contact@sample.co.jp"
}

Response:
{
    "company_id": 1,
    "stripe_customer_id": "cus_1234567890",
    "stripe_subscription_id": "sub_1234567890",
    "trial_end": "2024-01-15T00:00:00Z",
    "status": "active",
    "message": "2週間無料でご利用いただけます"
}
```

### 4.2 コンテンツ追加API
```
POST /api/v1/company/{company_id}/content/add
Content-Type: application/json

Request:
{
    "content_type": "AI経理秘書"
}

Response:
{
    "company_id": 1,
    "content_type": "AI経理秘書",
    "stripe_subscription_item_id": "si_1234567890",
    "next_billing_date": "2024-02-01T00:00:00Z",
    "status": "active",
    "message": "翌月の請求サイクルから1,500円が追加されます"
}
```

### 4.3 状態確認API
```
GET /api/v1/company/{company_id}/status

Response:
{
    "company": {
        "id": 1,
        "company_name": "株式会社サンプル",
        "email": "contact@sample.co.jp",
        "status": "active",
        "trial_end": "2024-01-15T00:00:00Z",
        "is_trial_active": true
    },
    "subscriptions": [
        {
            "content_type": "AI予定秘書",
            "status": "active",
            "added_at": "2024-01-01T00:00:00Z",
            "next_billing_date": null
        },
        {
            "content_type": "AI経理秘書",
            "status": "active",
            "added_at": "2024-01-10T00:00:00Z",
            "next_billing_date": "2024-02-01T00:00:00Z"
        }
    ],
    "billing_info": {
        "current_monthly_fee": 0,
        "next_monthly_fee": 5400,
        "trial_days_remaining": 5
    }
}
```

## 5. 解約制限チェック（更新版）

### 5.1 チェック項目
```
1. 企業の存在確認
2. 企業ステータスの確認（active/inactive）
3. コンテンツの契約確認
4. 無料期間の確認
5. Stripeサブスクリプション状態の確認
```

### 5.2 解約制限チェックAPI
```
POST /api/v1/company/restriction/check
Content-Type: application/json

Request:
{
    "company_id": 1,
    "content_type": "AI予定秘書"
}

Response:
{
    "is_restricted": false,
    "reason": "access_granted",
    "message": "利用可能です（無料期間中）",
    "company_id": 1,
    "content_type": "AI予定秘書",
    "trial_days_remaining": 5
}
```

## 6. 管理画面（更新版）

### 6.1 企業一覧
- 企業名
- メールアドレス
- 契約コンテンツ数
- 無料期間残り日数
- 次回課金予定額
- ステータス

### 6.2 企業詳細
- 基本情報
- 契約コンテンツ一覧（追加日、次回課金日）
- 請求情報（現在の月額、次月の月額）
- 無料期間状況
- 操作履歴

## 7. 現在のコードとの違い

### 7.1 削除する機能
- LINE関連（チャンネルID、アクセストークン等）
- 複雑なサブスクリプション管理
- 個人ユーザー機能
- 不要なデバッグ機能

### 7.2 追加する機能
- 無料期間管理
- 翌月課金管理
- 状態ログ機能
- 請求情報表示

### 7.3 変更する機能
- 料金体系（3,900円、2週間無料）
- コンテンツ追加タイミング（翌月課金）
- 解約処理（無料期間中は料金発生なし）

## 8. 実装優先度

### Phase 1: 基本機能
1. 企業登録・決済フロー（2週間無料）
2. Stripe連携（新しい料金体系）
3. 基本的な解約制限チェック

### Phase 2: 管理機能
1. コンテンツ追加/解除機能（翌月課金）
2. 状態確認機能
3. 管理画面

### Phase 3: 運用機能
1. 請求情報管理
2. 無料期間管理
3. ログ・監視機能

この要件により、シンプルで管理しやすく、新しい料金体系に対応したシステムが構築できます。 
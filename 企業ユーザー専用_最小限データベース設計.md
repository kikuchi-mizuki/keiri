# 企業ユーザー専用 最小限データベース設計

## 概要

AIコレクションズの企業ユーザー専用システムにおいて、必要最小限の情報のみを保存する効率的なデータベース設計です。

## データベース構造

### 1. 企業基本情報テーブル

```sql
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**保存する情報**:
- `company_name`: 企業名（必須）
- `email`: 企業メールアドレス（必須）
- `status`: 企業ステータス（active/inactive）
- `created_at`: 作成日時

**削除した情報**:
- `phone`: 電話番号
- `address`: 住所
- `industry`: 業種
- `employee_count`: 従業員数
- `updated_at`: 更新日時

### 2. 企業LINEアカウントテーブル

```sql
CREATE TABLE company_line_accounts (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    line_channel_id VARCHAR(255) NOT NULL,
    line_channel_access_token VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type)
);
```

**保存する情報**:
- `company_id`: 企業ID（外部キー）
- `content_type`: コンテンツタイプ（AI予定秘書、AI経理秘書等）
- `line_channel_id`: LINEチャンネルID（必須）
- `line_channel_access_token`: LINEアクセストークン（必須）
- `status`: LINEアカウントステータス（active/inactive）

**削除した情報**:
- `line_channel_secret`: LINEチャンネルシークレット
- `line_basic_id`: LINEベーシックID
- `line_qr_code_url`: QRコードURL
- `webhook_url`: Webhook URL
- `updated_at`: 更新日時

### 3. 企業サブスクリプション管理テーブル

```sql
CREATE TABLE company_subscriptions (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    subscription_status VARCHAR(50) DEFAULT 'active',
    current_period_end TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type)
);
```

**保存する情報**:
- `company_id`: 企業ID（外部キー）
- `content_type`: コンテンツタイプ
- `subscription_status`: サブスクリプション状態（active/canceled/past_due）
- `current_period_end`: 利用可能期限

**削除した情報**:
- `stripe_subscription_id`: StripeサブスクリプションID
- `stripe_customer_id`: Stripe顧客ID
- `current_period_start`: 期間開始日
- `trial_start`: トライアル開始日
- `trial_end`: トライアル終了日
- `updated_at`: 更新日時

## データ保存例

### 1. AI予定秘書追加時

```sql
-- 企業基本情報
INSERT INTO companies (company_name, email) 
VALUES ('株式会社サンプル', 'contact@sample.co.jp');

-- AI予定秘書用LINEアカウント
INSERT INTO company_line_accounts (company_id, content_type, line_channel_id, line_channel_access_token) 
VALUES (1, 'AI予定秘書', 'U1234567890abcdef', 'token_1234567890');

-- AI予定秘書用サブスクリプション
INSERT INTO company_subscriptions (company_id, content_type, current_period_end) 
VALUES (1, 'AI予定秘書', '2024-02-01 00:00:00');
```

### 2. AI経理秘書追加時（同じ企業）

```sql
-- 既存の企業IDを使用（company_id = 1）

-- AI経理秘書用LINEアカウント
INSERT INTO company_line_accounts (company_id, content_type, line_channel_id, line_channel_access_token) 
VALUES (1, 'AI経理秘書', 'U0987654321fedcba', 'token_0987654321');

-- AI経理秘書用サブスクリプション
INSERT INTO company_subscriptions (company_id, content_type, current_period_end) 
VALUES (1, 'AI経理秘書', '2024-02-01 00:00:00');
```

## 解約制限チェック処理

### 1. 最小限のチェック関数

```python
def check_company_restriction(line_channel_id, content_type):
    """
    企業ユーザーの解約制限チェック（最小限）
    """
    # 1. LINEチャンネルIDで企業LINEアカウントを取得
    line_account = get_company_line_account_by_channel_id(line_channel_id)
    if not line_account:
        return {'is_restricted': True, 'reason': 'line_account_not_found'}
    
    # 2. LINEアカウントのステータスをチェック
    if line_account['status'] != 'active':
        return {'is_restricted': True, 'reason': 'line_account_inactive'}
    
    # 3. 企業のサブスクリプション状態をチェック
    subscription = get_company_subscription(line_account['company_id'], content_type)
    if not subscription:
        return {'is_restricted': True, 'reason': 'subscription_not_found'}
    
    # 4. サブスクリプション状態と期限をチェック
    if subscription['subscription_status'] not in ['active', 'trialing']:
        return {'is_restricted': True, 'reason': 'subscription_inactive'}
    
    if subscription['current_period_end'] < datetime.now():
        return {'is_restricted': True, 'reason': 'subscription_expired'}
    
    return {'is_restricted': False, 'reason': 'access_granted'}
```

### 2. 必要最小限のSQLクエリ

```sql
-- 企業LINEアカウント取得
SELECT company_id, content_type, status 
FROM company_line_accounts 
WHERE line_channel_id = ? AND content_type = ?

-- 企業サブスクリプション取得
SELECT subscription_status, current_period_end 
FROM company_subscriptions 
WHERE company_id = ? AND content_type = ?
```

## 解約時の処理

### 1. コンテンツ別解約処理

```python
def cancel_company_content(company_id, content_type):
    """
    企業の特定コンテンツ解約処理（最小限）
    """
    # 1. LINEアカウントを停止
    update_company_line_account_status(company_id, content_type, 'inactive')
    
    # 2. サブスクリプションを停止
    update_company_subscription_status(company_id, content_type, 'canceled')
    
    # 3. 他のコンテンツが残っているかチェック
    remaining_contents = get_active_company_contents(company_id)
    if not remaining_contents:
        # 全コンテンツが解約された場合、企業情報も削除
        delete_company(company_id)
    
    return {
        'company_id': company_id,
        'content_type': content_type,
        'status': 'canceled',
        'remaining_contents': remaining_contents
    }
```

## 削除したテーブル

### 1. 不要なテーブル

```sql
-- 削除したテーブル
CREATE TABLE usage_logs (...),           -- 利用ログ
CREATE TABLE cancellation_history (...),  -- 解約履歴
CREATE TABLE company_payments (...),      -- 企業決済情報
CREATE TABLE company_notifications (...), -- 企業通知設定
CREATE TABLE company_deployments (...),   -- 企業デプロイメント
CREATE TABLE users (...),                -- 個人ユーザー情報
CREATE TABLE subscription_periods (...),  -- 個人サブスクリプション履歴
```

**削除理由**: 企業ユーザー専用システムでは不要

## パフォーマンス最適化

### 1. インデックス設計

```sql
-- LINEチャンネルID検索用インデックス
CREATE INDEX idx_company_line_accounts_channel_id 
ON company_line_accounts(line_channel_id);

-- サブスクリプション状態検索用インデックス
CREATE INDEX idx_company_subscriptions_status 
ON company_subscriptions(subscription_status);

-- 企業ID検索用インデックス
CREATE INDEX idx_company_line_accounts_company_id 
ON company_line_accounts(company_id);

CREATE INDEX idx_company_subscriptions_company_id 
ON company_subscriptions(company_id);
```

### 2. データ容量削減効果

**削除前の推定容量**:
- 企業基本情報: 約500バイト/レコード
- 企業LINEアカウント: 約1,000バイト/レコード
- 企業決済情報: 約800バイト/レコード
- 利用ログ: 約300バイト/レコード
- 解約履歴: 約400バイト/レコード

**削除後の推定容量**:
- 企業基本情報: 約200バイト/レコード
- 企業LINEアカウント: 約400バイト/レコード
- 企業サブスクリプション: 約300バイト/レコード

**削減効果**: 約70%の容量削減

## API設計

### 1. 解約制限チェックAPI

```
POST /api/v1/company/restriction/check
Content-Type: application/json

Request:
{
    "line_channel_id": "U1234567890abcdef",
    "content_type": "AI予定秘書"
}

Response:
{
    "is_restricted": false,
    "reason": "access_granted",
    "message": "利用可能です",
    "content_type": "AI予定秘書",
    "line_channel_id": "U1234567890abcdef"
}
```

### 2. 企業情報取得API

```
GET /api/v1/company/info/{line_channel_id}

Response:
{
    "company": {
        "id": 1,
        "company_name": "株式会社サンプル",
        "email": "contact@sample.co.jp",
        "status": "active"
    },
    "line_accounts": [
        {
            "content_type": "AI予定秘書",
            "line_channel_id": "U1234567890abcdef",
            "line_channel_access_token": "token_1234567890",
            "status": "active"
        }
    ],
    "subscriptions": [
        {
            "content_type": "AI予定秘書",
            "subscription_status": "active",
            "current_period_end": "2024-02-01T00:00:00Z"
        }
    ]
}
```

### 3. 企業コンテンツ解約API

```
POST /api/v1/company/cancel/{company_id}/{content_type}

Response:
{
    "message": "解約処理が完了しました",
    "result": {
        "company_id": 1,
        "content_type": "AI予定秘書",
        "status": "canceled",
        "remaining_contents": 0,
        "company_deleted": true
    }
}
```

## セキュリティ考慮事項

### 1. データ保護
- 企業情報の暗号化（必要に応じて）
- API認証の実装
- アクセスログの記録

### 2. バックアップ戦略
- 日次バックアップ
- 差分バックアップ
- 災害復旧計画

## 運用監視

### 1. 監視項目
- データベース接続状況
- 解約制限チェックの実行回数
- API応答時間
- エラー発生率

### 2. アラート設定
- データベース接続エラー
- API応答時間超過
- エラー率の閾値超過

## 今後の拡張

### 1. 短期拡張（3ヶ月以内）
- 詳細な利用統計の実装
- 自動復旧機能の強化
- 管理者ダッシュボードの実装

### 2. 中期拡張（6ヶ月以内）
- リアルタイム通知機能
- 高度な分析機能
- マルチリージョン対応

この最小限設計により、企業ユーザー専用システムの効率性と保守性が大幅に向上します。 
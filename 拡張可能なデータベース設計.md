# 拡張可能なデータベース設計

## 現在の設計と今後の拡張

### 1. 現在の設計（LINE専用）

```sql
-- 現在の設計
CREATE TABLE company_line_accounts (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    line_channel_id VARCHAR(255) NOT NULL,
    line_channel_access_token VARCHAR(255) NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type)
);
```

### 2. 拡張可能な設計（推奨）

```sql
-- プラットフォーム別アカウント管理
CREATE TABLE company_platform_accounts (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    platform_type VARCHAR(50) NOT NULL,  -- 'line', 'slack', 'notion', etc.
    platform_account_id VARCHAR(255) NOT NULL,
    platform_access_token VARCHAR(255) NOT NULL,
    platform_workspace_id VARCHAR(255),  -- Slack workspace, Notion workspace
    platform_channel_id VARCHAR(255),    -- Slack channel, LINE channel
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type, platform_type)
);

-- プラットフォーム別サブスクリプション管理
CREATE TABLE company_platform_subscriptions (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    platform_type VARCHAR(50) NOT NULL,
    subscription_status VARCHAR(50) DEFAULT 'active',
    current_period_end TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type, platform_type)
);
```

### 3. データ例

#### LINEアカウント例
```sql
INSERT INTO company_platform_accounts (
    company_id, content_type, platform_type, 
    platform_account_id, platform_access_token, platform_channel_id
) VALUES 
(1, 'AI予定秘書', 'line', 'U1234567890abcdef', 'token_1234567890', 'C1234567890'),
(1, 'AI経理秘書', 'line', 'U0987654321fedcba', 'token_0987654321', 'C0987654321');
```

#### Slackアカウント例
```sql
INSERT INTO company_platform_accounts (
    company_id, content_type, platform_type,
    platform_account_id, platform_access_token, platform_workspace_id, platform_channel_id
) VALUES 
(1, 'AI予定秘書', 'slack', 'U1234567890', 'xoxb-token-1234567890', 'T1234567890', 'C1234567890'),
(1, 'AI経理秘書', 'slack', 'U0987654321', 'xoxb-token-0987654321', 'T1234567890', 'C0987654321');
```

#### Notionアカウント例
```sql
INSERT INTO company_platform_accounts (
    company_id, content_type, platform_type,
    platform_account_id, platform_access_token, platform_workspace_id
) VALUES 
(1, 'AI予定秘書', 'notion', 'user_1234567890', 'secret-token-1234567890', 'workspace_1234567890'),
(1, 'AI経理秘書', 'notion', 'user_0987654321', 'secret-token-0987654321', 'workspace_1234567890');
```

### 4. 解約制限チェック関数の拡張

```python
def check_company_restriction_platform(company_id, content_type, platform_type):
    """
    企業ユーザーの解約制限チェック（マルチプラットフォーム対応）
    """
    conn = get_db_connection()
    if not conn:
        return {'is_restricted': True, 'reason': 'database_connection_error'}
    
    try:
        c = conn.cursor()
        
        # 1. プラットフォームアカウントを取得
        c.execute('''
            SELECT company_id, content_type, platform_type, status 
            FROM company_platform_accounts 
            WHERE company_id = %s AND content_type = %s AND platform_type = %s
        ''', (company_id, content_type, platform_type))
        
        platform_account = c.fetchone()
        if not platform_account:
            return {'is_restricted': True, 'reason': 'platform_account_not_found'}
        
        account_status = platform_account[3]
        
        # 2. プラットフォームアカウントのステータスをチェック
        if account_status != 'active':
            return {'is_restricted': True, 'reason': 'platform_account_inactive'}
        
        # 3. プラットフォーム別サブスクリプション状態をチェック
        c.execute('''
            SELECT subscription_status, current_period_end 
            FROM company_platform_subscriptions 
            WHERE company_id = %s AND content_type = %s AND platform_type = %s
        ''', (company_id, content_type, platform_type))
        
        subscription = c.fetchone()
        if not subscription:
            return {'is_restricted': True, 'reason': 'subscription_not_found'}
        
        subscription_status, current_period_end = subscription
        
        # 4. サブスクリプション状態と期限をチェック
        if subscription_status not in ['active', 'trialing']:
            return {'is_restricted': True, 'reason': 'subscription_inactive'}
        
        if current_period_end and current_period_end < datetime.now():
            return {'is_restricted': True, 'reason': 'subscription_expired'}
        
        return {'is_restricted': False, 'reason': 'access_granted'}
        
    except Exception as e:
        print(f"解約制限チェックエラー: {e}")
        return {'is_restricted': True, 'reason': 'check_error'}
    finally:
        conn.close()
```

### 5. API設計の拡張

#### 解約制限チェックAPI（拡張版）
```
POST /api/v1/company/restriction/check
Content-Type: application/json

Request:
{
    "company_id": 1,
    "content_type": "AI予定秘書",
    "platform_type": "line"  // または "slack", "notion"
}

Response:
{
    "is_restricted": false,
    "reason": "access_granted",
    "message": "利用可能です",
    "content_type": "AI予定秘書",
    "platform_type": "line"
}
```

#### 企業情報取得API（拡張版）
```
GET /api/v1/company/info/{company_id}

Response:
{
    "company": {
        "id": 1,
        "company_name": "株式会社サンプル",
        "email": "contact@sample.co.jp",
        "status": "active"
    },
    "platform_accounts": [
        {
            "content_type": "AI予定秘書",
            "platform_type": "line",
            "platform_channel_id": "U1234567890abcdef",
            "status": "active"
        },
        {
            "content_type": "AI予定秘書",
            "platform_type": "slack",
            "platform_workspace_id": "T1234567890",
            "platform_channel_id": "C1234567890",
            "status": "active"
        }
    ],
    "platform_subscriptions": [
        {
            "content_type": "AI予定秘書",
            "platform_type": "line",
            "subscription_status": "active",
            "current_period_end": "2024-02-01T00:00:00Z"
        }
    ]
}
```

### 6. 移行計画

#### Phase 1: 現在の設計を維持
- 既存のLINE機能を継続
- 新しいコンテンツ追加に対応

#### Phase 2: プラットフォーム拡張
- 新しいテーブル設計に移行
- Slack連携の実装
- Notion連携の実装

#### Phase 3: 完全移行
- 旧テーブルの廃止
- 全機能を新設計に統一

### 7. メリット

1. **コンテンツ追加**: 新しいAIサービスを簡単に追加可能
2. **プラットフォーム拡張**: LINE以外のプラットフォームに対応
3. **柔軟性**: 企業が複数プラットフォームで同じコンテンツを利用可能
4. **管理性**: プラットフォーム別の詳細な管理が可能
5. **スケーラビリティ**: 将来的な拡張に対応

この設計により、コンテンツとプラットフォームの両方で柔軟な拡張が可能になります。 
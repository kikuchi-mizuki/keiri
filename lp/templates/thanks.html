<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ご登録ありがとうございます - AI Collections</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .thanks-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
        }
        
        .thanks-card {
            background: white;
            border-radius: 24px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 40px;
        }
        
        .thanks-title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            line-height: 1.3;
        }
        
        .thanks-message {
            font-size: 16px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 40px;
        }
        
        .line-btn {
            display: inline-block;
            background: linear-gradient(135deg, #00b900, #009900);
            color: white;
            padding: 18px 36px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 185, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .line-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 185, 0, 0.4);
        }
        
        .note {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 30px;
        }
        
        .copyright {
            font-size: 12px;
            color: #d1d5db;
            margin-top: 20px;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 20px;
            border-radius: 12px;
            font-weight: 500;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .thanks-card {
                padding: 40px 20px;
                margin: 20px;
            }
            
            .thanks-title {
                font-size: 24px;
            }
            
            .success-icon {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="thanks-container">
        <div class="thanks-card">
            <div class="success-icon">✓</div>
            
            <h1 class="thanks-title">ご登録ありがとうございます！</h1>
            
            <p class="thanks-message">
                決済が完了しました。<br>
                LINE連携を行うと、すぐにAIコレクションズがご利用いただけます。
            </p>
            
            {% if email %}
                <a href="https://line.me/R/oaMessage/@077rkaxn/" target="_blank" class="line-btn" onclick="prepareWelcomeMessage()">
                    LINE連携を開始
                </a>
                
                <p class="note">
                    ※ボタンが反応しない場合は、しばらく待ってから再度お試しください。
                </p>
                
                <script>
                    function prepareWelcomeMessage() {
                        // 決済完了後の案内文送信準備
                        var userId = '{{ user_id }}';
                        console.log('準備開始: userId =', userId);
                        
                        if (userId && userId !== 'None') {
                            // まず自動診断を実行
                            diagnoseUser(userId).then(function(diagnosis) {
                                console.log('診断結果:', diagnosis);
                                
                                if (diagnosis.diagnosis.issues.length > 0) {
                                    // 問題がある場合は診断結果を表示
                                    showDiagnosisResult(diagnosis);
                                } else {
                                    // 問題がない場合は案内文送信準備を実行
                                    sendWelcomeMessage(userId);
                                }
                            }).catch(function(error) {
                                console.error('診断エラー:', error);
                                showMessage('診断でエラーが発生しました: ' + error.message, 'error');
                            });
                        } else {
                            console.log('ユーザーIDが無効です:', userId);
                            showMessage('ユーザーIDが無効です。', 'error');
                        }
                    }
                    
                    function diagnoseUser(userId) {
                        var url = '/line/debug/diagnose/' + userId;
                        console.log('診断URL:', url);
                        
                        return fetch(url, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(function(response) {
                            console.log('診断レスポンス:', response.status, response.statusText);
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }
                            return response.json();
                        });
                    }
                    
                    function sendWelcomeMessage(userId) {
                        var url = '/line/payment_completed/user/' + userId;
                        console.log('案内文送信URL:', url);
                        
                        fetch(url, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        })
                        .then(function(response) {
                            console.log('案内文送信レスポンス:', response.status, response.statusText);
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            console.log('案内文送信準備完了:', data);
                            showMessage('案内文送信準備が完了しました！', 'success');
                        })
                        .catch(function(error) {
                            console.error('案内文送信準備エラー:', error);
                            showMessage('案内文送信準備でエラーが発生しました: ' + error.message, 'error');
                        });
                    }
                    
                    function showDiagnosisResult(diagnosis) {
                        var issues = diagnosis.diagnosis.issues;
                        var recommendations = diagnosis.diagnosis.recommendations;
                        
                        var message = '診断結果:\n';
                        message += '• 問題: ' + issues.join(', ') + '\n';
                        message += '• 推奨: ' + recommendations.join(', ');
                        
                        showMessage(message, 'warning');
                        
                        // 詳細情報をコンソールに表示
                        console.log('詳細診断結果:', diagnosis);
                    }
                    
                    function showMessage(message, type) {
                        // 既存のメッセージを削除
                        var existingMessage = document.querySelector('.status-message');
                        if (existingMessage) {
                            existingMessage.remove();
                        }
                        
                        // 新しいメッセージを作成
                        var messageDiv = document.createElement('div');
                        messageDiv.className = 'status-message';
                        messageDiv.style.cssText = `
                            padding: 10px 15px;
                            border-radius: 8px;
                            margin: 10px 0;
                            font-size: 14px;
                            font-weight: 500;
                        `;
                        
                        if (type === 'success') {
                            messageDiv.style.backgroundColor = '#d1fae5';
                            messageDiv.style.color = '#065f46';
                            messageDiv.style.border = '1px solid #a7f3d0';
                        } else if (type === 'warning') {
                            messageDiv.style.backgroundColor = '#fef3c7';
                            messageDiv.style.color = '#92400e';
                            messageDiv.style.border = '1px solid #fde68a';
                        } else {
                            messageDiv.style.backgroundColor = '#fef2f2';
                            messageDiv.style.color = '#dc2626';
                            messageDiv.style.border = '1px solid #fecaca';
                        }
                        
                        messageDiv.textContent = message;
                        
                        // メッセージを挿入
                        var button = document.querySelector('.line-btn');
                        button.parentNode.insertBefore(messageDiv, button.nextSibling);
                        
                        // 3秒後にメッセージを削除
                        setTimeout(function() {
                            if (messageDiv.parentNode) {
                                messageDiv.remove();
                            }
                        }, 3000);
                    }
                </script>
            {% else %}
                <div class="error-message">
                    登録処理が完了していません。<br>
                    しばらく待ってから再度お試しください。
                </div>
            {% endif %}
            
            <div class="copyright">© AI Collections</div>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railwayトークン自動設定</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .setup-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .setup-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
        }
        .status-indicator {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .copy-btn {
            background: #6c757d;
            border: none;
            border-radius: 5px;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #5a6268;
        }
        .token-input {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
        }
        .token-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="setup-container p-5">
                    <h1 class="text-center mb-4">
                        <i class="fas fa-cog fa-spin text-primary"></i>
                        Railwayトークン自動設定
                    </h1>
                    
                    <!-- ステップインジケーター -->
                    <div class="step-indicator">
                        <div class="step active" id="step1">1</div>
                        <div class="step" id="step2">2</div>
                        <div class="step" id="step3">3</div>
                        <div class="step" id="step4">4</div>
                    </div>

                    <!-- ステータス表示 -->
                    <div id="statusArea"></div>

                    <!-- ステップ1: Railwayトークン取得 -->
                    <div class="setup-card card" id="step1Card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-key"></i> ステップ1: Railwayトークンの取得</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>手順:</h6>
                                    <ol>
                                        <li>Railwayダッシュボードにログイン</li>
                                        <li>右上のプロフィールアイコンをクリック</li>
                                        <li>"Account Settings"を選択</li>
                                        <li>"API"タブをクリック</li>
                                        <li>"Generate Token"をクリック</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <a href="https://railway.app/dashboard" target="_blank" class="btn btn-primary w-100">
                                        <i class="fas fa-external-link-alt"></i>
                                        Railwayダッシュボードを開く
                                    </a>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="railwayToken" class="form-label">生成されたトークン:</label>
                                <input type="text" class="form-control token-input" id="railwayToken" 
                                       placeholder="railway_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                                <div class="form-text">トークンをコピーして入力してください</div>
                            </div>
                            <button class="btn btn-success mt-3" onclick="validateToken()">
                                <i class="fas fa-check"></i> トークンを検証
                            </button>
                        </div>
                    </div>

                    <!-- ステップ2: プロジェクトID取得 -->
                    <div class="setup-card card" id="step2Card" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-project-diagram"></i> ステップ2: プロジェクトIDの取得</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>手順:</h6>
                                    <ol>
                                        <li>Railwayダッシュボードでプロジェクトを開く</li>
                                        <li>URLからプロジェクトIDをコピー</li>
                                        <li>例: https://railway.app/project/3e9475ce-ff6a-4443-ab6c-4eb21b7f4017</li>
                                        <li>プロジェクトID: 3e9475ce-ff6a-4443-ab6c-4eb21b7f4017</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <a href="https://railway.app/dashboard" target="_blank" class="btn btn-info w-100">
                                        <i class="fas fa-external-link-alt"></i>
                                        プロジェクト一覧を開く
                                    </a>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label for="projectId" class="form-label">プロジェクトID:</label>
                                <input type="text" class="form-control token-input" id="projectId" 
                                       placeholder="3e9475ce-ff6a-4443-ab6c-4eb21b7f4017">
                                <div class="form-text">URLからプロジェクトIDをコピーしてください</div>
                            </div>
                            <button class="btn btn-success mt-3" onclick="validateProjectId()">
                                <i class="fas fa-check"></i> プロジェクトIDを検証
                            </button>
                        </div>
                    </div>

                    <!-- ステップ3: 環境変数設定 -->
                    <div class="setup-card card" id="step3Card" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h5><i class="fas fa-cogs"></i> ステップ3: 環境変数の自動設定</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                以下の環境変数を自動で設定します
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6>RAILWAY_TOKEN</h6>
                                            <code id="displayToken">未設定</code>
                                            <button class="copy-btn mt-2" onclick="copyToClipboard('displayToken')">
                                                <i class="fas fa-copy"></i> コピー
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6>RAILWAY_PROJECT_ID</h6>
                                            <code id="displayProjectId">未設定</code>
                                            <button class="copy-btn mt-2" onclick="copyToClipboard('displayProjectId')">
                                                <i class="fas fa-copy"></i> コピー
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6>BASE_DOMAIN</h6>
                                            <code id="displayDomain">lp-production-9e2c.up.railway.app</code>
                                            <button class="copy-btn mt-2" onclick="copyToClipboard('displayDomain')">
                                                <i class="fas fa-copy"></i> コピー
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning mt-3 w-100" onclick="setupEnvironmentVariables()">
                                <i class="fas fa-magic"></i> 環境変数を自動設定
                            </button>
                        </div>
                    </div>

                    <!-- ステップ4: 完了確認 -->
                    <div class="setup-card card" id="step4Card" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-check-circle"></i> ステップ4: 設定完了</h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                            </div>
                            <h4>🎉 Railwayトークン設定が完了しました！</h4>
                            <p class="text-muted">これで企業登録時の自動デプロイが可能になります</p>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <a href="/company-registration" class="btn btn-primary w-100">
                                        <i class="fas fa-building"></i> 企業登録をテスト
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="/" class="btn btn-outline-secondary w-100">
                                        <i class="fas fa-home"></i> ホームに戻る
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let railwayToken = '';
        let projectId = '';

        // ステップ更新
        function updateStep(step) {
            currentStep = step;
            
            // ステップインジケーター更新
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                const cardElement = document.getElementById(`step${i}Card`);
                
                if (i < step) {
                    stepElement.className = 'step completed';
                    cardElement.style.display = 'none';
                } else if (i === step) {
                    stepElement.className = 'step active';
                    cardElement.style.display = 'block';
                } else {
                    stepElement.className = 'step';
                    cardElement.style.display = 'none';
                }
            }
        }

        // トークン検証
        async function validateToken() {
            const token = document.getElementById('railwayToken').value.trim();
            
            if (!token) {
                showStatus('danger', 'トークンを入力してください');
                return;
            }

            if (!token.startsWith('railway_')) {
                showStatus('danger', '有効なRailwayトークンを入力してください');
                return;
            }

            showStatus('info', 'トークンを検証中...');
            
            try {
                const response = await fetch('/api/v1/railway/validate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    railwayToken = token;
                    document.getElementById('displayToken').textContent = token.substring(0, 20) + '...';
                    showStatus('success', 'トークンが有効です');
                    setTimeout(() => updateStep(2), 1000);
                } else {
                    showStatus('danger', result.error || 'トークンの検証に失敗しました');
                }
            } catch (error) {
                showStatus('danger', 'トークン検証中にエラーが発生しました');
            }
        }

        // プロジェクトID検証
        async function validateProjectId() {
            const projectIdInput = document.getElementById('projectId').value.trim();
            
            if (!projectIdInput) {
                showStatus('danger', 'プロジェクトIDを入力してください');
                return;
            }

            if (!/^[a-f0-9-]{36}$/.test(projectIdInput)) {
                showStatus('danger', '有効なプロジェクトIDを入力してください');
                return;
            }

            showStatus('info', 'プロジェクトIDを検証中...');
            
            try {
                const response = await fetch('/api/v1/railway/validate-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        token: railwayToken,
                        project_id: projectIdInput 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    projectId = projectIdInput;
                    document.getElementById('displayProjectId').textContent = projectId;
                    showStatus('success', 'プロジェクトIDが有効です');
                    setTimeout(() => updateStep(3), 1000);
                } else {
                    showStatus('danger', result.error || 'プロジェクトIDの検証に失敗しました');
                }
            } catch (error) {
                showStatus('danger', 'プロジェクトID検証中にエラーが発生しました');
            }
        }

        // 環境変数設定
        async function setupEnvironmentVariables() {
            showStatus('info', '環境変数を設定中...');
            
            try {
                const response = await fetch('/api/v1/railway/setup-environment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: railwayToken,
                        project_id: projectId,
                        base_domain: 'lp-production-9e2c.up.railway.app'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('success', '環境変数の設定が完了しました');
                    setTimeout(() => updateStep(4), 1000);
                } else {
                    showStatus('danger', result.error || '環境変数の設定に失敗しました');
                }
            } catch (error) {
                showStatus('danger', '環境変数設定中にエラーが発生しました');
            }
        }

        // ステータス表示
        function showStatus(type, message) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        // クリップボードにコピー
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showStatus('success', 'クリップボードにコピーしました');
            }).catch(() => {
                showStatus('danger', 'コピーに失敗しました');
            });
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updateStep(1);
        });
    </script>
</body>
</html> 
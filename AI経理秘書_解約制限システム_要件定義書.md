# AI経理秘書 解約制限システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
AI経理秘書 解約制限システム

### 1.2 目的
AI経理秘書のLINE公式アカウントで、メールアドレス認証によるユーザー認証を行い、解約済みユーザーがサービスを利用できないように制限し、AIコレクションズ公式LINEとWEBサイトへの誘導を行うシステムを構築する。

### 1.3 背景
- 現在、AI経理秘書は独立したサービスとして運営されている
- ユーザーが解約しても、AI経理秘書のLINE公式アカウントでサービスを利用できてしまう
- メールアドレス認証による確実なユーザー認証と、解約情報を共有データベースで管理し、リアルタイムで制限をかける必要がある

### 1.4 対象ユーザー
- AI経理秘書のLINE公式アカウント利用者
- 解約済みユーザー
- アクティブユーザー

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 メールアドレス認証機能
**機能名：** メールアドレス認証
**概要：** ユーザーがメッセージを送信した際に、まずメールアドレスの入力を求める

**詳細仕様：**
- 入力：メールアドレス
- 処理：`users`テーブルでメールアドレスを照合
- 出力：認証結果（成功/失敗）
- 実行タイミング：メッセージ受信時（最初に実行）

**認証ロジック：**
```sql
SELECT id, email, line_user_id FROM users 
WHERE email = ?
```

#### 2.1.2 利用制限チェック機能
**機能名：** リアルタイム利用制限チェック
**概要：** メールアドレス認証後、`usage_logs`テーブルとStripe APIでコンテンツの利用状況と契約期間をチェックする

**詳細仕様：**
- 入力：ユーザーID（メールアドレス認証で取得）
- 処理：
  1. `usage_logs`テーブルでAI経理秘書の利用状況を確認
  2. Stripe APIでサブスクリプションの契約期間とステータスを確認
  3. 契約期間内かつ有効なステータスかどうかを判定
- 出力：利用可能/不可の判定結果
- 実行タイミング：メールアドレス認証成功後

**判定ロジック：**
```sql
-- 1. usage_logsでコンテンツ追加履歴を確認
SELECT u.stripe_subscription_id 
FROM usage_logs ul
JOIN users u ON ul.user_id = u.id
WHERE ul.user_id = ? AND ul.content_type = 'AI経理秘書'

-- 2. Stripe APIでサブスクリプション状況を確認
subscription = stripe.Subscription.retrieve(stripe_subscription_id)

-- 3. 契約期間とステータスをチェック
if subscription.status == 'active':
    return True  # アクティブなサブスクリプション
elif subscription.status == 'past_due':
    return True  # 支払い遅延中だが利用可能（請求は始まっている）
elif subscription.status == 'canceled' and subscription.current_period_end > now():
    return True  # キャンセル済みだが期間内（請求は始まっている）
elif subscription.status == 'trialing':
    return False  # トライアル期間中（請求が始まっていない）
elif subscription.status in ['incomplete', 'incomplete_expired', 'unpaid']:
    return False  # 支払い未完了・期限切れ・未払い
else:
    return False  # その他の無効なステータス
```

**利用可能な条件：**
1. `usage_logs`にAI経理秘書の記録が存在
2. かつ、以下のいずれかの条件を満たす：
   - Stripeサブスクリプションがアクティブ（`status = 'active'`）
   - または、支払い遅延中（`status = 'past_due'`）
   - または、キャンセル済みでも契約期間がまだ終了していない（`current_period_end > 現在時刻`）

**利用不可な条件：**
1. `usage_logs`にAI経理秘書の記録が存在しない
2. または、請求がまだ始まっていない（`status = 'trialing'`）
3. または、支払いが未完了（`status = 'incomplete'`, `'incomplete_expired'`, `'unpaid'`）
4. または、契約期間が終了している（`current_period_end <= 現在時刻`）
5. または、サブスクリプションが無効なステータス

#### 2.1.3 制限メッセージ送信機能
**機能名：** 解約制限メッセージ送信
**概要：** 利用できないユーザーに制限メッセージを送信する

**詳細仕様：**
- メッセージ形式：LINE Button Template
- 内容：
  - タイトル：「AI経理秘書の利用制限」
  - 本文：「AI経理秘書は利用できません。AIコレクションズの公式LINEまたはWEBサイトで再度ご登録いただき、サービスをご利用ください。」
  - ボタン1：「AIコレクションズ公式LINE」（URL: https://lin.ee/sLVefUq）
  - ボタン2：「WEBサイト」（URL: https://lp-production-9e2c.up.railway.app/）

#### 2.1.4 通常サービス提供機能
**機能名：** アクティブユーザー向けサービス提供
**概要：** 利用可能なユーザーには通常のAI経理秘書サービスを提供する

**詳細仕様：**
- メールアドレス認証と利用制限チェックが「利用可能」の場合のみ実行
- 既存のAI経理秘書機能をそのまま提供
- 認証・制限チェックは既存機能の前に実行

### 2.2 非機能要件

#### 2.2.1 性能要件
- メールアドレス認証応答時間：3秒以内
- 利用制限チェック応答時間：3秒以内
- データベース接続タイムアウト：5秒
- 同時接続数：100ユーザーまで対応

#### 2.2.2 可用性要件
- システム稼働率：99.5%以上
- データベース接続エラー時は制限しない（サービス継続）
- メンテナンス時間：月1回、2時間以内

#### 2.2.3 セキュリティ要件
- メールアドレスの適切な検証
- データベース接続情報の暗号化
- API認証（必要に応じて）
- ログの適切な管理

#### 2.2.4 保守性要件
- ログ出力による動作監視
- エラーハンドリングの実装
- 設定変更の容易性

## 3. システム構成

### 3.1 アーキテクチャ
```
AI経理秘書LINE Bot
    ↓
メールアドレス認証
    ↓
利用制限チェックAPI
    ↓
共有PostgreSQLデータベース
    ↓
usersテーブル + usage_logsテーブル
```

### 3.2 データベース構成
**共有PostgreSQLデータベース**
- テーブル：`users`
  - カラム：
    - `id`: 主キー
    - `email`: メールアドレス（認証用）
    - `line_user_id`: LINEユーザーID
    - `stripe_customer_id`: Stripe顧客ID
    - `stripe_subscription_id`: StripeサブスクリプションID

- テーブル：`usage_logs`
  - カラム：
    - `id`: 主キー
    - `user_id`: ユーザーID（usersテーブルへの外部キー）
    - `content_type`: コンテンツタイプ（'AI経理秘書'）
    - `is_free`: 無料フラグ
    - `created_at`: 追加日時

### 3.3 外部連携
- **AIコレクションズメインアプリ**: ユーザー管理・コンテンツ管理
- **共有PostgreSQLデータベース**: ユーザー情報・利用状況の参照
- **LINE Messaging API**: メッセージ送信
- **AIコレクションズ公式LINE**: https://lin.ee/sLVefUq
- **AIコレクションズWEBサイト**: https://lp-production-9e2c.up.railway.app/

## 4. 実装仕様

### 4.1 技術スタック
- **プログラミング言語**: Python
- **フレームワーク**: Flask（既存のLINE Botフレームワーク）
- **データベース**: PostgreSQL
- **外部API**: LINE Messaging API
- **ライブラリ**: requests, psycopg2-binary

### 4.2 ファイル構成
```
ai-accounting-secretary/
├── app.py                    # メインアプリケーション
├── line_integration_code.py  # 認証・利用制限チェック機能
├── requirements.txt          # 依存関係
├── .env                      # 環境変数
└── templates/
    └── index.html           # テスト用ページ
```

### 4.3 主要クラス・関数

#### 4.3.1 LineAuthenticationCheckerクラス
```python
class LineAuthenticationChecker:
    def __init__(self, content_type="AI経理秘書")
    def authenticate_user_by_email(self, email)
    def check_user_usage(self, user_id)
    def get_restriction_message(self)
```

#### 4.3.2 メッセージ処理関数
```python
def handle_accounting_message(event, line_bot_api)
def safe_authenticate_and_check(line_user_id, content_type)
```

### 4.4 環境変数
```bash
DATABASE_URL=postgresql://postgres:password@host:port/database
AI_COLLECTIONS_LINE_URL=https://lin.ee/sLVefUq
AI_COLLECTIONS_WEB_URL=https://lp-production-9e2c.up.railway.app/
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret
```

## 5. 実装手順

### 5.1 フェーズ1: 基盤構築（1-2日）
1. 共有PostgreSQLデータベースの確認
2. 必要なテーブルの存在確認
3. 接続テストの実施

### 5.2 フェーズ2: 機能実装（2-3日）
1. `line_integration_code.py`の追加
2. メールアドレス認証機能の実装
3. 利用制限チェック機能の実装
4. 既存LINE Botコードの修正

### 5.3 フェーズ3: テスト（1-2日）
1. 単体テスト
2. 統合テスト
3. ユーザーシナリオテスト

### 5.4 フェーズ4: デプロイ（1日）
1. テスト環境でのデプロイ
2. 動作確認
3. 本番環境へのデプロイ

## 6. テスト仕様

### 6.1 単体テスト
- メールアドレス認証機能のテスト
- 利用制限チェック機能のテスト
- 制限メッセージ生成機能のテスト
- データベース接続機能のテスト

### 6.2 統合テスト
- 解約済みユーザーでの制限動作確認
- アクティブユーザーでの通常動作確認
- エラー時のフォールバック動作確認

### 6.3 ユーザーシナリオテスト
**シナリオ1: 未登録ユーザー**
1. 未登録ユーザーがAI経理秘書にメッセージ送信
2. メールアドレス入力を求められる
3. 存在しないメールアドレスを入力
4. 制限メッセージが表示される
5. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ2: 解約済みユーザー**
1. 解約済みユーザーがAI経理秘書にメッセージ送信
2. メールアドレス認証が成功
3. `usage_logs`テーブルでAI経理秘書の記録が存在しないことを確認
4. 制限メッセージが表示される
5. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ3: アクティブユーザー**
1. アクティブユーザーがAI経理秘書にメッセージ送信
2. メールアドレス認証が成功
3. `usage_logs`テーブルでAI経理秘書の記録が存在することを確認
4. Stripe APIでサブスクリプションが`active`であることを確認
5. 通常のAI経理秘書サービスが提供される
6. 制限メッセージは表示されない

**シナリオ4: トライアル期間中のユーザー**
1. トライアル期間中のユーザーがAI経理秘書にメッセージ送信
2. メールアドレス認証が成功
3. `usage_logs`テーブルでAI経理秘書の記録が存在することを確認
4. Stripe APIでサブスクリプションが`trialing`であることを確認
5. 制限メッセージが表示される（請求が始まっていないため）
6. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ5: 支払い未完了ユーザー**
1. 支払い未完了ユーザーがAI経理秘書にメッセージ送信
2. メールアドレス認証が成功
3. `usage_logs`テーブルでAI経理秘書の記録が存在することを確認
4. Stripe APIでサブスクリプションが`incomplete`であることを確認
5. 制限メッセージが表示される（支払いが完了していないため）
6. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ6: データベース接続エラー**
1. データベース接続エラーが発生
2. 認証・制限チェックをスキップして通常サービスを提供
3. エラーログが記録される

## 7. 運用・保守

### 7.1 監視項目
- データベース接続状況
- メールアドレス認証の実行回数
- 利用制限チェックの実行回数
- エラー発生率
- レスポンス時間

### 7.2 ログ管理
- アプリケーションログ
- 認証ログ
- エラーログ
- アクセスログ
- データベース接続ログ

### 7.3 バックアップ
- データベースの定期バックアップ
- 設定ファイルのバックアップ
- ログファイルのアーカイブ

## 8. リスク・対策

### 8.1 技術リスク
**リスク**: データベース接続エラー
**対策**: エラー時のフォールバック処理を実装

**リスク**: API応答遅延
**対策**: タイムアウト設定とリトライ機能を実装

**リスク**: メールアドレス認証の失敗
**対策**: 適切なエラーメッセージと再試行機能を実装

### 8.2 運用リスク
**リスク**: 誤ってアクティブユーザーを制限
**対策**: ログ監視とアラート機能を実装

**リスク**: ユーザー情報の同期遅延
**対策**: 定期的なデータ整合性チェックを実装

## 9. 成功指標

### 9.1 定量的指標
- メールアドレス認証成功率: 95%以上
- 利用制限チェック成功率: 99%以上
- 平均応答時間: 3秒以内
- エラー発生率: 1%以下

### 9.2 定性的指標
- 解約済みユーザーの適切な制限
- アクティブユーザーのサービス継続
- ユーザー体験の向上
- セキュリティの向上

## 10. 今後の拡張

### 10.1 短期拡張（3ヶ月以内）
- 他のサービス（AI予定秘書、AIタスクコンシェルジュ）への展開
- 詳細な利用統計の実装
- 自動復旧機能の強化

### 10.2 中期拡張（6ヶ月以内）
- リアルタイム通知機能
- 管理者ダッシュボードの実装
- 高度な分析機能

### 10.3 長期拡張（1年以内）
- 機械学習による異常検知
- 自動スケーリング機能
- マルチリージョン対応

## 11. 承認・承認者

### 11.1 承認者
- プロジェクトマネージャー: [承認者名]
- 技術責任者: [承認者名]
- 運用責任者: [承認者名]

### 11.2 承認日
- 要件定義書承認日: [日付]
- 実装開始日: [日付]
- 本番リリース日: [日付]

---

**文書作成日**: 2024年12月19日  
**文書バージョン**: 2.0  
**作成者**: AI Assistant  
**最終更新日**: 2024年12月19日 
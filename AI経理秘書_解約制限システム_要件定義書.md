# AI経理秘書 解約制限システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
AI経理秘書 解約制限システム

### 1.2 目的
AI経理秘書のLINE公式アカウントで、解約済みユーザーがサービスを利用できないように制限し、AIコレクションズ公式LINEへの誘導を行うシステムを構築する。

### 1.3 背景
- 現在、AI経理秘書は独立したサービスとして運営されている
- ユーザーが解約しても、AI経理秘書のLINE公式アカウントでサービスを利用できてしまう
- 解約情報を共有データベースで管理し、リアルタイムで制限をかける必要がある

### 1.4 対象ユーザー
- AI経理秘書のLINE公式アカウント利用者
- 解約済みユーザー
- アクティブユーザー

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 利用制限チェック機能
**機能名：** リアルタイム利用制限チェック
**概要：** ユーザーがメッセージを送信した際に、解約履歴をチェックする

**詳細仕様：**
- 入力：LINEユーザーID
- 処理：共有PostgreSQLデータベースの`cancellation_history`テーブルを参照
- 出力：制限有無の判定結果
- 実行タイミング：メッセージ受信時（最初に実行）

**判定ロジック：**
```sql
SELECT COUNT(*) FROM cancellation_history 
WHERE user_id = (SELECT id FROM users WHERE line_user_id = ?) 
AND content_type = 'AI経理秘書'
```

#### 2.1.2 制限メッセージ送信機能
**機能名：** 解約制限メッセージ送信
**概要：** 解約済みユーザーに制限メッセージを送信する

**詳細仕様：**
- メッセージ形式：LINE Button Template
- 内容：
  - タイトル：「AI経理秘書の利用制限」
  - 本文：「AI経理秘書は解約されているため、公式LINEを利用できません。AIコレクションズの公式LINEで再度ご登録いただき、サービスをご利用ください。」
  - ボタン1：「AIコレクションズ公式LINE」（URL: https://line.me/R/ti/p/@ai_collections）
  - ボタン2：「サービス詳細」（URL: https://ai-collections.herokuapp.com）

#### 2.1.3 通常サービス提供機能
**機能名：** アクティブユーザー向けサービス提供
**概要：** 解約していないユーザーには通常のAI経理秘書サービスを提供する

**詳細仕様：**
- 制限チェックが「制限なし」の場合のみ実行
- 既存のAI経理秘書機能をそのまま提供
- 制限チェックは既存機能の前に実行

### 2.2 非機能要件

#### 2.2.1 性能要件
- 制限チェック応答時間：3秒以内
- データベース接続タイムアウト：5秒
- 同時接続数：100ユーザーまで対応

#### 2.2.2 可用性要件
- システム稼働率：99.5%以上
- データベース接続エラー時は制限しない（サービス継続）
- メンテナンス時間：月1回、2時間以内

#### 2.2.3 セキュリティ要件
- データベース接続情報の暗号化
- API認証（必要に応じて）
- ログの適切な管理

#### 2.2.4 保守性要件
- ログ出力による動作監視
- エラーハンドリングの実装
- 設定変更の容易性

## 3. システム構成

### 3.1 アーキテクチャ
```
AI経理秘書LINE Bot
    ↓
利用制限チェックAPI
    ↓
共有PostgreSQLデータベース
    ↓
cancellation_historyテーブル
```

### 3.2 データベース構成
**共有PostgreSQLデータベース**
- テーブル：`cancellation_history`
- カラム：
  - `id`: 主キー
  - `user_id`: ユーザーID（usersテーブルへの外部キー）
  - `content_type`: コンテンツタイプ（'AI経理秘書'）
  - `cancelled_at`: 解約日時

### 3.3 外部連携
- **AIコレクションズメインアプリ**: 解約履歴の管理
- **共有PostgreSQLデータベース**: 解約情報の参照
- **LINE Messaging API**: メッセージ送信

## 4. 実装仕様

### 4.1 技術スタック
- **プログラミング言語**: Python
- **フレームワーク**: Flask（既存のLINE Botフレームワーク）
- **データベース**: PostgreSQL
- **外部API**: LINE Messaging API
- **ライブラリ**: requests, psycopg2-binary

### 4.2 ファイル構成
```
ai-accounting-secretary/
├── app.py                    # メインアプリケーション
├── line_integration_code.py  # 利用制限チェック機能
├── requirements.txt          # 依存関係
├── .env                      # 環境変数
└── templates/
    └── index.html           # テスト用ページ
```

### 4.3 主要クラス・関数

#### 4.3.1 LineRestrictionCheckerクラス
```python
class LineRestrictionChecker:
    def __init__(self, content_type="AI経理秘書")
    def check_user_restriction(self, line_user_id)
    def get_restriction_message(self, line_user_id)
```

#### 4.3.2 メッセージ処理関数
```python
def handle_accounting_message(event, line_bot_api)
def safe_check_restriction(line_user_id, content_type)
```

### 4.4 環境変数
```bash
DATABASE_URL=postgresql://postgres:password@host:port/database
AI_COLLECTIONS_BASE_URL=https://ai-collections.herokuapp.com
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret
```

## 5. 実装手順

### 5.1 フェーズ1: 基盤構築（1-2日）
1. 共有PostgreSQLデータベースの確認
2. 必要なテーブルの存在確認
3. 接続テストの実施

### 5.2 フェーズ2: 機能実装（2-3日）
1. `line_integration_code.py`の追加
2. 既存LINE Botコードの修正
3. 環境変数の設定

### 5.3 フェーズ3: テスト（1-2日）
1. 単体テスト
2. 統合テスト
3. ユーザーシナリオテスト

### 5.4 フェーズ4: デプロイ（1日）
1. テスト環境でのデプロイ
2. 動作確認
3. 本番環境へのデプロイ

## 6. テスト仕様

### 6.1 単体テスト
- 利用制限チェック機能のテスト
- 制限メッセージ生成機能のテスト
- データベース接続機能のテスト

### 6.2 統合テスト
- 解約済みユーザーでの制限動作確認
- アクティブユーザーでの通常動作確認
- エラー時のフォールバック動作確認

### 6.3 ユーザーシナリオテスト
**シナリオ1: 解約済みユーザー**
1. 解約済みユーザーがAI経理秘書にメッセージ送信
2. 制限メッセージが表示される
3. AIコレクションズ公式LINEへの誘導が正常に動作

**シナリオ2: アクティブユーザー**
1. アクティブユーザーがAI経理秘書にメッセージ送信
2. 通常のAI経理秘書サービスが提供される
3. 制限メッセージは表示されない

**シナリオ3: データベース接続エラー**
1. データベース接続エラーが発生
2. 制限チェックをスキップして通常サービスを提供
3. エラーログが記録される

## 7. 運用・保守

### 7.1 監視項目
- データベース接続状況
- 制限チェックの実行回数
- エラー発生率
- レスポンス時間

### 7.2 ログ管理
- アプリケーションログ
- エラーログ
- アクセスログ
- データベース接続ログ

### 7.3 バックアップ
- データベースの定期バックアップ
- 設定ファイルのバックアップ
- ログファイルのアーカイブ

## 8. リスク・対策

### 8.1 技術リスク
**リスク**: データベース接続エラー
**対策**: エラー時のフォールバック処理を実装

**リスク**: API応答遅延
**対策**: タイムアウト設定とリトライ機能を実装

### 8.2 運用リスク
**リスク**: 誤ってアクティブユーザーを制限
**対策**: ログ監視とアラート機能を実装

**リスク**: 解約情報の同期遅延
**対策**: 定期的なデータ整合性チェックを実装

## 9. 成功指標

### 9.1 定量的指標
- 制限チェック成功率: 99%以上
- 平均応答時間: 3秒以内
- エラー発生率: 1%以下

### 9.2 定性的指標
- 解約済みユーザーの適切な制限
- アクティブユーザーのサービス継続
- ユーザー体験の向上

## 10. 今後の拡張

### 10.1 短期拡張（3ヶ月以内）
- 他のサービス（AI予定秘書、AIタスクコンシェルジュ）への展開
- 詳細な利用統計の実装
- 自動復旧機能の強化

### 10.2 中期拡張（6ヶ月以内）
- リアルタイム通知機能
- 管理者ダッシュボードの実装
- 高度な分析機能

### 10.3 長期拡張（1年以内）
- 機械学習による異常検知
- 自動スケーリング機能
- マルチリージョン対応

## 11. 承認・承認者

### 11.1 承認者
- プロジェクトマネージャー: [承認者名]
- 技術責任者: [承認者名]
- 運用責任者: [承認者名]

### 11.2 承認日
- 要件定義書承認日: [日付]
- 実装開始日: [日付]
- 本番リリース日: [日付]

---

**文書作成日**: 2024年12月19日  
**文書バージョン**: 1.0  
**作成者**: AI Assistant  
**最終更新日**: 2024年12月19日 
# AI経理秘書 解約制限システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
AI経理秘書 解約制限システム

### 1.2 目的
AI経理秘書のLINE公式アカウントで、解約済みユーザーがサービスを利用できないように制限し、AIコレクションズ公式LINEとWEBサイトへの誘導を行うシステムを構築する。

### 1.3 背景
- 現在、AI経理秘書は独立したサービスとして運営されている
- ユーザーが解約しても、AI経理秘書のLINE公式アカウントでサービスを利用できてしまう
- 解約情報を共有データベースで管理し、リアルタイムで制限をかける必要がある

### 1.4 対象ユーザー
- AI経理秘書のLINE公式アカウント利用者
- 解約済みユーザー
- アクティブユーザー

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 解約制限チェック機能
**機能名：** リアルタイム解約制限チェック
**概要：** ユーザーがメッセージを送信した際に、`cancellation_history`テーブルで解約履歴をチェックする

**詳細仕様：**
- 入力：LINEユーザーID
- 処理：
  1. `users`テーブルでLINEユーザーIDからユーザーIDを取得
  2. `cancellation_history`テーブルでAI経理秘書の解約履歴を確認
  3. 解約されているかどうかを判定
- 出力：利用可能/不可の判定結果
- 実行タイミング：メッセージ受信時

**判定ロジック：**
```sql
-- 1. ユーザーIDを取得
SELECT id FROM users WHERE line_user_id = ?

-- 2. subscription_periodsテーブルでサブスクリプション状態をチェック
SELECT subscription_status FROM subscription_periods 
WHERE user_id = ? AND stripe_subscription_id IS NOT NULL
ORDER BY created_at DESC
LIMIT 1

-- 3. 解約されているかどうかを判定
if subscription_status in ['canceled', 'incomplete', 'incomplete_expired', 'unpaid', 'past_due']:
    return True  # 解約済み（利用不可）
elif subscription_status in ['active', 'trialing']:
    return False  # 利用可能
else:
    return True  # レコードが存在しない場合は解約済みとみなす
```

**解約制限の判定基準：**
- **利用不可（制限対象）**：
  - `canceled` - 解約済み（期間終了後）
  - `incomplete` - 支払い未完了
  - `incomplete_expired` - 支払い期限切れ
  - `unpaid` - 未払い
  - `past_due` - 支払い遅延
  - レコードが存在しない場合

- **利用可能**：
  - `active` - アクティブ（解約後も期限内であれば利用可能）
  - `trialing` - トライアル期間中

#### 2.1.2 制限メッセージ送信機能
**機能名：** 解約制限メッセージ送信
**概要：** 利用できないユーザーに制限メッセージを送信する

**詳細仕様：**
- メッセージ形式：LINE Button Template
- 内容：
  - タイトル：「AI経理秘書の利用制限」
  - 本文：「AI経理秘書は解約されているため利用できません。AIコレクションズの公式LINEまたはWEBサイトで再度ご登録いただき、サービスをご利用ください。」
  - ボタン1：「AIコレクションズ公式LINE」（URL: https://lin.ee/sLVefUq）
  - ボタン2：「WEBサイト」（URL: https://lp-production-9e2c.up.railway.app/）

#### 2.1.3 通常サービス提供機能
**機能名：** アクティブユーザー向けサービス提供
**概要：** 利用可能なユーザーには通常のAI経理秘書サービスを提供する

**詳細仕様：**
- 解約制限チェックが「利用可能」の場合のみ実行
- 既存のAI経理秘書機能をそのまま提供
- 制限チェックは既存機能の前に実行

### 2.2 非機能要件

#### 2.2.1 性能要件
- 解約制限チェック応答時間：3秒以内
- データベース接続タイムアウト：5秒
- 同時接続数：100ユーザーまで対応

#### 2.2.2 可用性要件
- システム稼働率：99.5%以上
- データベース接続エラー時は制限しない（サービス継続）
- メンテナンス時間：月1回、2時間以内

#### 2.2.3 セキュリティ要件
- データベース接続情報の暗号化
- API認証（必要に応じて）
- ログの適切な管理

#### 2.2.4 保守性要件
- ログ出力による動作監視
- エラーハンドリングの実装
- 設定変更の容易性

## 3. システム構成

### 3.1 アーキテクチャ
```
AI経理秘書LINE Bot
    ↓
解約制限チェックAPI
    ↓
共有PostgreSQLデータベース
    ↓
usersテーブル + cancellation_historyテーブル
```

### 3.2 データベース構成
**共有PostgreSQLデータベース**
- テーブル：`users`
  - カラム：
    - `id`: 主キー
    - `email`: メールアドレス
    - `line_user_id`: LINEユーザーID
    - `stripe_customer_id`: Stripe顧客ID
    - `stripe_subscription_id`: StripeサブスクリプションID

- テーブル：`subscription_periods`
  - カラム：
    - `id`: 主キー
    - `user_id`: ユーザーID（usersテーブルへの外部キー）
    - `stripe_subscription_id`: StripeサブスクリプションID
    - `subscription_status`: サブスクリプション状態
    - `current_period_start`: 現在の期間開始日
    - `current_period_end`: 現在の期間終了日
    - `trial_start`: トライアル開始日
    - `trial_end`: トライアル終了日
    - `created_at`: 作成日時
    - `updated_at`: 更新日時

### 3.3 外部連携
- **AIコレクションズメインアプリ**: ユーザー管理・コンテンツ管理
- **共有PostgreSQLデータベース**: ユーザー情報・解約履歴の参照
- **LINE Messaging API**: メッセージ送信
- **AIコレクションズ公式LINE**: https://lin.ee/sLVefUq
- **AIコレクションズWEBサイト**: https://lp-production-9e2c.up.railway.app/

## 4. 実装仕様

### 4.1 技術スタック
- **プログラミング言語**: Python
- **フレームワーク**: Flask
- **データベース**: PostgreSQL
- **外部API**: LINE Messaging API
- **ライブラリ**: requests, psycopg2-binary

### 4.2 ファイル構成
```
accounting-service/
├── app.py                    # メインアプリケーション
├── requirements.txt          # 依存関係
├── .env                      # 環境変数
└── templates/
    └── index.html           # テスト用ページ
```

### 4.3 主要関数

#### 4.3.1 解約制限チェック関数
```python
def check_user_restriction(line_user_id):
    """ユーザーの利用制限をチェック"""
    # 1. ユーザーIDを取得
    # 2. 解約履歴をチェック
    # 3. 制限判定を返す
```

### 4.4 環境変数
```bash
DATABASE_URL=postgresql://postgres:password@host:port/database
AI_COLLECTIONS_LINE_URL=https://lin.ee/sLVefUq
AI_COLLECTIONS_WEB_URL=https://lp-production-9e2c.up.railway.app/
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret
```

## 5. 実装状況

### 5.1 完了済み機能
✅ **データベース構造**
- `subscription_periods`テーブルの作成
- インデックスの作成
- Railway PostgreSQLでの動作確認

✅ **解約制限チェック機能**
- `check_user_restriction`関数の実装
- サブスクリプション状態の確認ロジック
- エラーハンドリング

✅ **制限メッセージ機能**
- 制限メッセージの生成
- LINE Button Template形式での送信
- AIコレクションズへの誘導リンク

✅ **統合システム**
- AIコレクションズメインアプリとの連携
- 解約処理時のサブスクリプション状態更新
- 複数サービス（AI予定秘書、AI経理秘書、AIタスクコンシェルジュ）対応

### 5.2 実装済みAPI
✅ **利用制限チェックAPI**
```
POST /line/check_restriction/{content_type}
```

✅ **制限メッセージ取得API**
```
POST /line/restriction_message/{content_type}
```

✅ **デバッグ用API**
```
GET /line/debug/cancellation_history/{user_id}
```

### 5.3 実装済みサービス
✅ **cancellation_service.py**
- サブスクリプション状態のチェック
- 解約状態の判定
- 解約コンテンツの取得

✅ **cancellation_period_service.py**
- 契約期間管理
- サブスクリプション状態の更新
- アクセス権限のチェック

## 6. テスト仕様

### 6.1 単体テスト
- 解約制限チェック機能のテスト
- 制限メッセージ生成機能のテスト
- データベース接続機能のテスト

### 6.2 統合テスト
- 解約済みユーザーでの制限動作確認
- アクティブユーザーでの通常動作確認
- エラー時のフォールバック動作確認

### 6.3 ユーザーシナリオテスト
**シナリオ1: 未登録ユーザー**
1. 未登録ユーザーがAI経理秘書にメッセージ送信
2. 制限メッセージが表示される
3. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ2: 解約済みユーザー（期間終了後）**
1. 解約済みユーザーがAI経理秘書にメッセージ送信
2. `subscription_periods`テーブルでサブスクリプション状態が`canceled`であることを確認
3. 制限メッセージが表示される
4. AIコレクションズ公式LINEとWEBサイトへの誘導が正常に動作

**シナリオ3: アクティブユーザー**
1. アクティブユーザーがAI経理秘書にメッセージ送信
2. `subscription_periods`テーブルでサブスクリプション状態が`active`であることを確認
3. 通常のAI経理秘書サービスが提供される
4. 制限メッセージは表示されない

**シナリオ4: 解約後も期限内のユーザー**
1. 解約後も期限内のユーザーがAI経理秘書にメッセージ送信
2. `subscription_periods`テーブルでサブスクリプション状態が`active`であることを確認
3. 通常のAI経理秘書サービスが提供される（期限内のため利用可能）
4. 制限メッセージは表示されない

**シナリオ5: データベース接続エラー**
1. データベース接続エラーが発生
2. 制限チェックをスキップして通常サービスを提供
3. エラーログが記録される

## 7. 運用・保守

### 7.1 監視項目
- データベース接続状況
- 解約制限チェックの実行回数
- エラー発生率
- レスポンス時間

### 7.2 ログ管理
- アプリケーションログ
- 制限チェックログ
- エラーログ
- アクセスログ
- データベース接続ログ

### 7.3 バックアップ
- データベースの定期バックアップ
- 設定ファイルのバックアップ
- ログファイルのアーカイブ

## 8. リスク・対策

### 8.1 技術リスク
**リスク**: データベース接続エラー
**対策**: エラー時のフォールバック処理を実装済み

**リスク**: API応答遅延
**対策**: タイムアウト設定とリトライ機能を実装済み

**リスク**: サブスクリプション状態の同期遅延
**対策**: リアルタイムでのサブスクリプション状態更新を実装済み

### 8.2 運用リスク
**リスク**: 誤ってアクティブユーザーを制限
**対策**: ログ監視とアラート機能を実装済み

**リスク**: ユーザー情報の同期遅延
**対策**: 定期的なデータ整合性チェックを実装済み

## 9. 成功指標

### 9.1 定量的指標
- 解約制限チェック成功率: 99%以上
- 平均応答時間: 3秒以内
- エラー発生率: 1%以下

### 9.2 定性的指標
- 解約済みユーザーの適切な制限
- アクティブユーザーのサービス継続
- ユーザー体験の向上
- セキュリティの向上

## 10. 今後の拡張

### 10.1 短期拡張（3ヶ月以内）
- 詳細な利用統計の実装
- 自動復旧機能の強化
- 管理者ダッシュボードの実装

### 10.2 中期拡張（6ヶ月以内）
- リアルタイム通知機能
- 高度な分析機能
- マルチリージョン対応

### 10.3 長期拡張（1年以内）
- 機械学習による異常検知
- 自動スケーリング機能
- 高度なセキュリティ機能

## 11. 承認・承認者

### 11.1 承認者
- プロジェクトマネージャー: [承認者名]
- 技術責任者: [承認者名]
- 運用責任者: [承認者名]

### 11.2 承認日
- 要件定義書承認日: [日付]
- 実装開始日: 2024年12月19日
- 本番リリース日: 2024年12月19日

---

**文書作成日**: 2024年12月19日  
**文書バージョン**: 4.0  
**作成者**: AI Assistant  
**最終更新日**: 2024年12月19日  
**更新内容**: subscription_periodsテーブルを使用した解約制限チェックへの変更、解約後も期限内は利用可能とする仕様の明確化 
# シンプル要件定義

## 1. 基本フロー

### 1.1 企業登録・決済フロー
```
1. LPで企業名とメールアドレスを入力
2. 月額費用を決済（Stripe）
3. DBに企業情報を登録
   - ID（自動生成）
   - 企業名
   - メールアドレス
   - ステータス（active）
```

### 1.2 コンテンツ管理フロー
```
1. コンテンツ追加/解除の操作
2. Stripeと連携してサブスクリプション更新
3. DBにコンテンツ毎のステータスを保存
```

## 2. データベース設計（シンプル版）

### 2.1 企業テーブル
```sql
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    stripe_customer_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 コンテンツサブスクリプションテーブル
```sql
CREATE TABLE company_content_subscriptions (
    id SERIAL PRIMARY KEY,
    company_id INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    stripe_subscription_id VARCHAR(255),
    stripe_price_id VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (company_id) REFERENCES companies(id),
    UNIQUE(company_id, content_type)
);
```

## 3. 利用可能なコンテンツ

### 3.1 現在のコンテンツ
- `AI予定秘書`
- `AI経理秘書`
- `AIタスクコンシェルジュ`

### 3.2 料金体系
- 基本月額：5,000円
- コンテンツ追加：1,500円/コンテンツ
- 例：1コンテンツ = 5,000円、2コンテンツ = 6,500円

## 4. Stripe連携

### 4.1 決済フロー
```
1. 企業登録時にStripe Customer作成
2. 基本月額のSubscription作成
3. コンテンツ追加時にStripe Subscription Item追加
4. コンテンツ解除時にStripe Subscription Item削除
```

### 4.2 Webhook処理
```
- customer.subscription.created: サブスクリプション作成
- customer.subscription.updated: サブスクリプション更新
- customer.subscription.deleted: サブスクリプション削除
- invoice.payment_succeeded: 支払い成功
- invoice.payment_failed: 支払い失敗
```

## 5. API設計

### 5.1 企業登録API
```
POST /api/v1/company/register
Content-Type: application/json

Request:
{
    "company_name": "株式会社サンプル",
    "email": "contact@sample.co.jp"
}

Response:
{
    "company_id": 1,
    "stripe_customer_id": "cus_1234567890",
    "stripe_subscription_id": "sub_1234567890",
    "status": "active"
}
```

### 5.2 コンテンツ追加API
```
POST /api/v1/company/{company_id}/content/add
Content-Type: application/json

Request:
{
    "content_type": "AI経理秘書"
}

Response:
{
    "company_id": 1,
    "content_type": "AI経理秘書",
    "stripe_subscription_item_id": "si_1234567890",
    "status": "active"
}
```

### 5.3 コンテンツ解除API
```
POST /api/v1/company/{company_id}/content/remove
Content-Type: application/json

Request:
{
    "content_type": "AI経理秘書"
}

Response:
{
    "company_id": 1,
    "content_type": "AI経理秘書",
    "status": "canceled"
}
```

### 5.4 企業情報取得API
```
GET /api/v1/company/{company_id}

Response:
{
    "company": {
        "id": 1,
        "company_name": "株式会社サンプル",
        "email": "contact@sample.co.jp",
        "stripe_customer_id": "cus_1234567890",
        "status": "active"
    },
    "subscriptions": [
        {
            "content_type": "AI予定秘書",
            "stripe_subscription_id": "sub_1234567890",
            "stripe_price_id": "price_1234567890",
            "status": "active"
        },
        {
            "content_type": "AI経理秘書",
            "stripe_subscription_id": "sub_0987654321",
            "stripe_price_id": "price_0987654321",
            "status": "active"
        }
    ]
}
```

## 6. 解約制限チェック

### 6.1 チェック項目
```
1. 企業の存在確認
2. 企業ステータスの確認（active/inactive）
3. コンテンツの契約確認
4. Stripeサブスクリプション状態の確認
5. 支払い状況の確認
```

### 6.2 解約制限チェックAPI
```
POST /api/v1/company/restriction/check
Content-Type: application/json

Request:
{
    "company_id": 1,
    "content_type": "AI予定秘書"
}

Response:
{
    "is_restricted": false,
    "reason": "access_granted",
    "message": "利用可能です",
    "company_id": 1,
    "content_type": "AI予定秘書"
}
```

## 7. 管理画面

### 7.1 企業一覧
- 企業名
- メールアドレス
- 契約コンテンツ
- ステータス
- 登録日

### 7.2 企業詳細
- 基本情報
- 契約コンテンツ一覧
- Stripe情報
- 操作履歴

## 8. 削除した機能

### 8.1 LINE関連
- LINEチャンネルID
- LINEアクセストークン
- LINE連携機能

### 8.2 複雑な管理機能
- プラットフォーム別管理
- 詳細な利用ログ
- 複雑な権限管理

## 9. 実装優先度

### Phase 1: 基本機能
1. 企業登録・決済フロー
2. Stripe連携
3. 基本的な解約制限チェック

### Phase 2: 管理機能
1. コンテンツ追加/解除機能
2. 管理画面
3. 詳細なAPI

### Phase 3: 運用機能
1. ログ機能
2. 監視機能
3. バックアップ機能

この要件により、シンプルで管理しやすいシステムが構築できます。 